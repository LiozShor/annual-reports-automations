<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מיפוי שאלון למסמכים - משרד רו"ח משה עציץ</title>
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Mapping Editor specific styles */
        .mapping-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--sp-4) var(--sp-5);
            margin-bottom: var(--sp-3);
            box-shadow: var(--shadow-xs);
            border-inline-start: 3px solid var(--brand-500);
            transition: all var(--transition-base);
        }

        .mapping-card:hover {
            box-shadow: var(--shadow-md);
        }

        .mapping-card.modified {
            border-inline-start-color: var(--warning-500);
            background: var(--warning-50);
        }

        .mapping-card.has-docs {
            border-inline-start-color: var(--success-500);
        }

        .mapping-card.no-docs {
            opacity: 0.6;
            border-inline-start-color: var(--gray-300);
        }

        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--sp-3);
            gap: var(--sp-3);
        }

        .mapping-id {
            font-family: monospace;
            font-size: var(--text-xs);
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 3px 6px;
            border-radius: var(--radius-sm);
        }

        .mapping-badges {
            display: flex;
            gap: var(--sp-2);
            flex-wrap: wrap;
        }

        .badge {
            font-size: var(--text-xs);
            padding: 3px 8px;
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        .badge-spouse {
            background: #FCE7F3;
            color: #be185d;
        }

        .badge-peritem {
            background: var(--info-100);
            color: var(--info-700);
        }

        .badge-condition {
            background: var(--success-100);
            color: var(--success-700);
        }

        .mapping-question {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--sp-3);
            line-height: 1.5;
        }

        .mapping-question-en {
            font-size: var(--text-xs);
            color: var(--gray-500);
            margin-bottom: var(--sp-3);
            direction: ltr;
            text-align: right;
        }

        .mapping-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--sp-3);
        }

        @media (max-width: 768px) {
            .mapping-fields {
                grid-template-columns: 1fr;
            }
        }

        .mapping-field {
            display: flex;
            flex-direction: column;
            gap: var(--sp-1);
        }

        .mapping-field label {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--gray-500);
        }

        .mapping-field input,
        .mapping-field select {
            padding: var(--sp-3) var(--sp-4);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            transition: border-color var(--transition-base);
        }

        .mapping-field input:focus,
        .mapping-field select:focus {
            outline: none;
            border-color: var(--brand-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .mapping-field input.modified,
        .mapping-field select.modified {
            border-color: var(--warning-500);
            background: var(--warning-50);
        }

        .mapping-docs {
            margin-top: var(--sp-3);
            padding: var(--sp-3);
            background: var(--success-50);
            border-radius: var(--radius-md);
            border-inline-start: 3px solid var(--success-500);
        }

        .mapping-docs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-2);
        }

        .mapping-docs-header strong {
            font-size: var(--text-xs);
            color: var(--success-700);
            display: flex;
            align-items: center;
            gap: var(--sp-2);
        }

        .mapping-docs-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--sp-2);
        }

        .doc-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-1);
            padding: var(--sp-1) var(--sp-3);
            background: white;
            border: 1px solid var(--success-500);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--success-700);
        }

        .doc-tag button {
            background: none;
            border: none;
            color: var(--danger-500);
            cursor: pointer;
            padding: 0;
            margin-inline-start: var(--sp-1);
            font-size: var(--text-sm);
            display: inline-flex;
            align-items: center;
        }

        .add-doc-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-1);
            padding: var(--sp-1) var(--sp-3);
            background: var(--success-500);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .add-doc-btn:hover {
            background: var(--success-700);
        }

        .mapping-preview {
            margin-top: var(--sp-3);
            padding: var(--sp-3) var(--sp-4);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            border-inline-start: 3px solid var(--brand-200);
        }

        .mapping-preview strong {
            color: var(--success-700);
        }

        .category-section {
            margin-bottom: var(--sp-8);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--sp-3);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: var(--sp-4);
            padding-bottom: var(--sp-3);
            border-bottom: 1px solid var(--gray-200);
        }

        .changes-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gray-800);
            color: white;
            padding: var(--sp-4) var(--sp-8);
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .changes-bar.visible {
            display: flex;
        }

        .changes-count {
            font-size: var(--text-base);
            display: flex;
            align-items: center;
            gap: var(--sp-2);
        }

        .changes-actions {
            display: flex;
            gap: var(--sp-3);
        }

        .search-filter-bar {
            display: flex;
            gap: var(--sp-3);
            margin-bottom: var(--sp-5);
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: var(--sp-4) var(--sp-5) var(--sp-4) var(--sp-12);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
        }

        .search-box .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filter-select {
            padding: var(--sp-4) var(--sp-5);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: var(--text-sm);
            background: white;
            min-width: 180px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-2);
            color: var(--gray-500);
            text-decoration: none;
            margin-bottom: var(--sp-5);
            font-size: var(--text-sm);
        }

        .back-link:hover {
            color: var(--brand-500);
        }

        .toggle-row {
            display: flex;
            gap: var(--sp-3);
            margin-top: var(--sp-3);
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: var(--sp-2);
            font-size: var(--text-xs);
            color: var(--gray-600);
        }

        .toggle-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .translate-btn {
            background: var(--brand-50);
            border: 1px solid var(--brand-200);
            color: var(--brand-600);
            padding: var(--sp-2) var(--sp-3);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-1);
        }

        .translate-btn:hover {
            background: var(--brand-100);
        }

        .doc-dropdown {
            position: absolute;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            width: 300px;
        }

        .doc-dropdown-item {
            padding: var(--sp-3) var(--sp-4);
            cursor: pointer;
            font-size: var(--text-xs);
            border-bottom: 1px solid var(--gray-100);
        }

        .doc-dropdown-item:hover {
            background: var(--success-50);
        }

        .doc-dropdown-item:last-child {
            border-bottom: none;
        }

        .status-legend {
            display: flex;
            gap: var(--sp-4);
            margin-bottom: var(--sp-4);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--sp-2);
            font-size: var(--text-xs);
            color: var(--gray-500);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.has-docs {
            background: var(--success-500);
        }

        .legend-dot.no-docs {
            background: var(--gray-300);
        }

        .legend-dot.modified {
            background: var(--warning-500);
        }

        /* Accordion styles with design system tokens */
        .accordion {
            margin-bottom: var(--sp-4);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xs);
        }

        .accordion-header {
            background: var(--gray-50);
            padding: var(--sp-4) var(--sp-5);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
            user-select: none;
        }

        .accordion-header:hover {
            background: var(--gray-100);
        }

        .accordion.open .accordion-header {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent;
            background: var(--brand-600);
            color: white;
            border-color: var(--brand-600);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: var(--sp-3);
            font-size: var(--text-base);
            font-weight: 600;
        }

        .accordion-title .emoji {
            font-size: var(--text-xl);
        }

        .accordion-count {
            font-size: var(--text-xs);
            font-weight: normal;
            opacity: 0.7;
        }

        .accordion-icon {
            transition: transform var(--transition-slow);
        }

        .accordion.open .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
            border: 1px solid var(--gray-200);
            border-top: none;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
        }

        .accordion.open .accordion-body {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .accordion-content {
            padding: var(--sp-4) var(--sp-5);
        }

        .accordion-actions {
            display: flex;
            gap: var(--sp-3);
            margin-bottom: var(--sp-4);
        }

        .accordion-actions .btn {
            padding: var(--sp-2) var(--sp-4);
            font-size: var(--text-xs);
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1><i data-lucide="lock" class="icon"></i> מיפוי שאלון למסמכים</h1>
            <p>משרד רו"ח משה עציץ</p>
            <form onsubmit="login(); return false;">
                <input type="text" name="username" autocomplete="username" style="display:none" value="admin">
                <input type="password" id="passwordInput" placeholder="הזן סיסמה" autocomplete="current-password">
            </form>
            <div id="loginError" class="login-error">סיסמה שגויה</div>
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">
                <i data-lucide="zap" class="icon-sm"></i> כניסה
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="app">
        <!-- Persistent Navbar -->
        <nav class="admin-navbar">
            <div class="nav-brand">
                <i data-lucide="building-2" class="icon"></i>
                פורטל ניהול
            </div>
            <div class="nav-links">
                <a href="index.html"><i data-lucide="bar-chart-3" class="icon-sm"></i> לוח בקרה</a>
                <a href="document-types-viewer.html"><i data-lucide="file-text" class="icon-sm"></i> סוגי מסמכים</a>
                <a href="questionnaire-mapping-editor.html" class="active"><i data-lucide="git-branch" class="icon-sm"></i>
                    מיפוי שאלון</a>
            </div>
            <div class="nav-actions">
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i data-lucide="refresh-cw" class="icon-sm"></i> רענן
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i data-lucide="log-out" class="icon-sm"></i> התנתק
                </button>
            </div>
        </nav>

        <div class="content">

            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="list" class="icon"></i> שאלות ומסמכים נדרשים (<span id="totalCount">0</span>)
                    </h2>
                    <a href="https://github.com/LiozShor/annual-reports-client-portal/blob/main/questionnaire-mapping.js"
                        target="_blank" class="btn btn-outline">
                        <i data-lucide="github" class="icon-sm"></i> צפה בקוד המקור
                    </a>
                </div>
                <div class="card-body">
                    <div class="status-legend">
                        <div class="legend-item">
                            <div class="legend-dot has-docs"></div>
                            <span>שאלה עם מסמכים נדרשים</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot no-docs"></div>
                            <span>שאלה ללא מסמכים</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot modified"></div>
                            <span>שינוי לא נשמר</span>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="חיפוש לפי שאלה או מסמך..."
                                oninput="filterMappings()">
                            <i data-lucide="search" class="icon-sm search-icon"></i>
                        </div>
                        <select class="filter-select" id="categoryFilter" onchange="filterMappings()">
                            <option value="">כל הקטגוריות</option>
                        </select>
                        <select class="filter-select" id="docsFilter" onchange="filterMappings()">
                            <option value="">הכל</option>
                            <option value="with-docs">עם מסמכים</option>
                            <option value="without-docs">ללא מסמכים</option>
                        </select>
                    </div>

                    <div class="accordion-actions">
                        <button class="btn btn-outline" onclick="expandAllAccordions()">
                            <i data-lucide="maximize-2" class="icon-sm"></i> פתח הכל
                        </button>
                        <button class="btn btn-outline" onclick="collapseAllAccordions()">
                            <i data-lucide="minimize-2" class="icon-sm"></i> סגור הכל
                        </button>
                    </div>

                    <div id="mappingsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon"><div class="spinner"></div></div>
                            <p>טוען מיפויים...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Changes Bar -->
    <div id="changesBar" class="changes-bar">
        <div class="changes-count">
            <i data-lucide="pencil" class="icon-sm"></i> <span id="changesCount">0</span> שינויים לא נשמרו
        </div>
        <div class="changes-actions">
            <button class="btn btn-secondary" onclick="discardChanges()">
                <i data-lucide="x" class="icon-sm"></i> בטל
            </button>
            <button class="btn btn-warning" onclick="previewChanges()">
                <i data-lucide="eye" class="icon-sm"></i> תצוגה מקדימה
            </button>
            <button class="btn btn-success" onclick="saveChanges()">
                <i data-lucide="upload-cloud" class="icon-sm"></i> שמור ל-GitHub
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <p id="loadingText">מעבד...</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"><i data-lucide="circle-check" class="icon-2xl"></i></div>
            <h2 class="modal-title" id="modalTitle">הושלם בהצלחה!</h2>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-stats" id="modalStats"></div>
            <button class="btn btn-primary" onclick="closeModal()">סגור</button>
        </div>
    </div>

    <!-- Document Dropdown (hidden by default) -->
    <div id="docDropdown" class="doc-dropdown" style="display: none;"></div>

    <script>
        // Configuration
        const API_BASE = 'https://liozshor.app.n8n.cloud/webhook';
        const ADMIN_TOKEN_KEY = 'QKiwUBXVH@%#1gD7t@rB]<,dM.[NC5b_';
        const SESSION_FLAG_KEY = 'admin_session_active';
        const MAPPING_API = 'https://raw.githubusercontent.com/LiozShor/annual-reports-client-portal/main/questionnaire-mapping.json';
        const DOC_TYPES_API = 'https://raw.githubusercontent.com/LiozShor/annual-reports-client-portal/main/document-types.json';

        // State
        let authToken = localStorage.getItem(ADMIN_TOKEN_KEY) || '';
        let mappings = [];
        let categories = {};
        let documentTypes = {};
        let originalMappings = [];
        let changes = {};

        // Sample data for preview
        const SAMPLE_DATA = {
            year: '2024',
            employer: 'קפה גרג',
            institution: 'בנק לאומי',
            company: 'הראל'
        };

        // Category → Lucide icon name mapping
        const CATEGORY_ICONS = {
            hidden: 'settings',
            personal: 'user',
            family: 'users',
            children: 'baby',
            employment: 'briefcase',
            pension: 'landmark',
            nii: 'building',
            investments: 'trending-up',
            realestate: 'house',
            insurance: 'shield',
            military: 'award',
            education: 'graduation-cap',
            health: 'heart-pulse',
            donations: 'heart',
            withholding: 'clipboard-list',
            other: 'file-text'
        };

        function categoryIconHtml(catId) {
            const icon = CATEGORY_ICONS[catId] || 'file-text';
            return `<i data-lucide="${icon}" class="icon-sm"></i>`;
        }

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // ==================== AUTH ====================

        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) return;

            showLoading('מאמת...');

            try {
                const response = await fetch(`${API_BASE}/admin-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Invalid JSON response:', text);
                    throw new Error('שרת לא החזיר תשובה תקינה');
                }

                hideLoading();

                if (data.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem(ADMIN_TOKEN_KEY, authToken);
                    sessionStorage.setItem(SESSION_FLAG_KEY, 'true');
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').classList.add('visible');
                    loadData();
                } else {
                    document.getElementById('loginError').textContent = data.error || 'סיסמה שגויה';
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (error) {
                hideLoading();
                document.getElementById('loginError').textContent = 'שגיאת התחברות';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem(ADMIN_TOKEN_KEY);
            sessionStorage.removeItem(SESSION_FLAG_KEY);
            authToken = '';
            location.reload();
        }

        async function checkAuth() {
            if (!authToken) return;

            // If session already active in this browser window, skip API call
            if (sessionStorage.getItem(SESSION_FLAG_KEY) === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').classList.add('visible');
                loadData();
                return;
            }

            // New tab/window - verify token with API
            try {
                const response = await fetch(`${API_BASE}/admin-verify?token=${authToken}`);
                const data = await response.json();

                if (data.ok) {
                    sessionStorage.setItem(SESSION_FLAG_KEY, 'true');
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').classList.add('visible');
                    loadData();
                } else {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    sessionStorage.removeItem(SESSION_FLAG_KEY);
                    authToken = '';
                }
            } catch (error) {
                // Token invalid, stay on login
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // ==================== LOAD DATA ====================

        async function loadData() {
            showLoading('טוען נתונים...');

            try {
                // Load both mapping and document types in parallel
                const [mappingRes, docTypesRes] = await Promise.all([
                    fetch(MAPPING_API),
                    fetch(DOC_TYPES_API)
                ]);

                const mappingData = await mappingRes.json();
                const docTypesData = await docTypesRes.json();

                hideLoading();

                categories = mappingData.categories || {};
                mappings = mappingData.mappings || [];
                documentTypes = docTypesData.document_types || {};
                originalMappings = JSON.parse(JSON.stringify(mappings));
                changes = {};

                // Populate category filter
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
                for (const [catId, cat] of Object.entries(categories)) {
                    if (catId !== 'hidden') {
                        categoryFilter.innerHTML += `<option value="${catId}">${cat.he}</option>`;
                    }
                }

                document.getElementById('totalCount').textContent = mappings.length;
                renderMappings();
                if (typeof lucide !== 'undefined') lucide.createIcons();

            } catch (error) {
                hideLoading();
                console.error('Error loading data:', error);
                showModal('error', 'שגיאה', 'לא ניתן לטעון את הנתונים');
            }
        }

        function refreshData() {
            if (Object.keys(changes).length > 0) {
                if (!confirm('יש שינויים לא שמורים. האם אתה בטוח שברצונך לרענן?')) {
                    return;
                }
            }
            loadData();
        }

        // ==================== RENDER ====================

        function renderMappings() {
            const container = document.getElementById('mappingsContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const docsFilter = document.getElementById('docsFilter').value;

            // Group by category
            const byCategory = {};
            for (const mapping of mappings) {
                // Skip hidden fields
                if (mapping.category === 'hidden') continue;

                const cat = mapping.category || 'other';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(mapping);
            }

            let html = '';
            const categoryOrder = Object.keys(categories).filter(c => c !== 'hidden');

            for (const catId of categoryOrder) {
                if (categoryFilter && categoryFilter !== catId) continue;
                if (!byCategory[catId]) continue;

                const catMeta = categories[catId];
                let items = byCategory[catId];

                // Filter by search
                if (searchTerm) {
                    items = items.filter(m =>
                        m.label?.he?.toLowerCase().includes(searchTerm) ||
                        m.label?.en?.toLowerCase().includes(searchTerm) ||
                        m.id?.toLowerCase().includes(searchTerm) ||
                        m.documents?.some(d => d.toLowerCase().includes(searchTerm))
                    );
                }

                // Filter by docs
                if (docsFilter === 'with-docs') {
                    items = items.filter(m => m.documents?.length > 0);
                } else if (docsFilter === 'without-docs') {
                    items = items.filter(m => !m.documents?.length);
                }

                if (items.length === 0) continue;

                html += `
                    <div class="accordion" data-category="${catId}">
                        <div class="accordion-header" onclick="toggleAccordion('${catId}')">
                            <div class="accordion-title">
                                ${categoryIconHtml(catId)}
                                <span>${catMeta.he}</span>
                                <span class="accordion-count">(${items.length})</span>
                            </div>
                            <i data-lucide="chevron-down" class="icon-sm accordion-icon"></i>
                        </div>
                        <div class="accordion-body">
                            <div class="accordion-content">
                `;

                for (const mapping of items) {
                    html += renderMappingCard(mapping);
                }

                html += '</div></div></div>';
            }

            if (!html) {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i data-lucide="search" class="icon-2xl"></i></div>
                        <p>לא נמצאו תוצאות</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            updateChangesBar();
        }

        // ==================== ACCORDION FUNCTIONS ====================

        function toggleAccordion(categoryId) {
            const accordion = document.querySelector(`.accordion[data-category="${categoryId}"]`);
            if (accordion) {
                accordion.classList.toggle('open');
            }
        }

        function expandAllAccordions() {
            document.querySelectorAll('.accordion').forEach(acc => acc.classList.add('open'));
        }

        function collapseAllAccordions() {
            document.querySelectorAll('.accordion').forEach(acc => acc.classList.remove('open'));
        }

        function renderMappingCard(mapping) {
            const isModified = changes[mapping.id] !== undefined;
            const hasDocs = mapping.documents?.length > 0;
            const currentMapping = { ...mapping, ...changes[mapping.id] };

            let badgesHtml = '';
            if (mapping.isSpouse) {
                badgesHtml += '<span class="badge badge-spouse">בן/בת זוג</span>';
            }
            if (mapping.perItem) {
                badgesHtml += '<span class="badge badge-peritem">לכל פריט</span>';
            }
            if (mapping.condition) {
                badgesHtml += `<span class="badge badge-condition">IF: ${mapping.condition}</span>`;
            }

            let docsHtml = '';
            if (hasDocs) {
                const docTags = currentMapping.documents.map(docId => {
                    const docType = documentTypes[docId];
                    const docName = docType?.name_he || docId;
                    return `
                        <span class="doc-tag">
                            ${escapeHtml(docName)}
                            <button onclick="removeDoc('${mapping.id}', '${docId}')" title="הסר">
                                <i data-lucide="x" class="icon-sm"></i>
                            </button>
                        </span>
                    `;
                }).join('');

                docsHtml = `
                    <div class="mapping-docs">
                        <div class="mapping-docs-header">
                            <strong><i data-lucide="file-text" class="icon-sm"></i> מסמכים נדרשים:</strong>
                            <button class="add-doc-btn" onclick="showDocDropdown('${mapping.id}', this)">
                                <i data-lucide="plus" class="icon-sm"></i> הוסף
                            </button>
                        </div>
                        <div class="mapping-docs-list">
                            ${docTags}
                        </div>
                    </div>
                `;
            } else {
                docsHtml = `
                    <div class="mapping-docs" style="background: var(--gray-50); border-inline-start-color: var(--gray-300);">
                        <div class="mapping-docs-header">
                            <strong style="color: var(--gray-500);"><i data-lucide="file-text" class="icon-sm"></i> אין מסמכים נדרשים</strong>
                            <button class="add-doc-btn" onclick="showDocDropdown('${mapping.id}', this)">
                                <i data-lucide="plus" class="icon-sm"></i> הוסף מסמך
                            </button>
                        </div>
                    </div>
                `;
            }



            // Build document name preview from document-types
            let docPreviewHtml = '';
            if (hasDocs && currentMapping.documents?.length > 0) {
                const docPreviews = currentMapping.documents.map(docId => {
                    const docType = documentTypes[docId];
                    if (!docType) return `<div style="color: var(--gray-400);">${docId} (לא נמצא)</div>`;

                    // Replace placeholders with sample data
                    let displayName = docType.name_he || docId;
                    displayName = displayName
                        .replace('{year}', SAMPLE_DATA.year)
                        .replace('{employer}', SAMPLE_DATA.employer)
                        .replace('{institution}', SAMPLE_DATA.institution)
                        .replace('{company}', SAMPLE_DATA.company)
                        .replace('{platform}', 'Binance')
                        .replace('{product}', 'קרן פנסיה')
                        .replace('{withdrawal_type}', 'פיצויי פיטורין')
                        .replace('{name}', 'ישראל ישראלי')
                        .replace('{client}', 'חברת ABC');

                    return `<div style="padding: var(--sp-1) 0; display: flex; align-items: center; gap: var(--sp-1);"><i data-lucide="file-text" class="icon-sm"></i> ${escapeHtml(displayName)}</div>`;
                }).join('');

                docPreviewHtml = `
                    <div class="mapping-preview" style="background: var(--success-50); border-inline-start-color: var(--success-500);">
                        <div style="font-size: var(--text-xs); color: var(--gray-500); margin-bottom: var(--sp-2); display: flex; align-items: center; gap: var(--sp-1);">
                            <i data-lucide="eye" class="icon-sm"></i> דוגמה לתצוגת המסמך:
                        </div>
                        ${docPreviews}
                    </div>
                `;
            }

            return `
                <div class="mapping-card ${isModified ? 'modified' : ''} ${hasDocs ? 'has-docs' : 'no-docs'}" data-id="${mapping.id}">
                    <div class="mapping-header">
                        <span class="mapping-id">${mapping.id}</span>
                        <div class="mapping-badges">${badgesHtml}</div>
                    </div>
                    <div class="mapping-question">${escapeHtml(currentMapping.label?.he || '')}</div>
                    <div class="mapping-question-en">${escapeHtml(currentMapping.label?.en || '')}</div>

                    <div class="toggle-row">
                        <label class="toggle-item">
                            <input type="checkbox"
                                   ${currentMapping.perItem ? 'checked' : ''}
                                   data-mapping="${mapping.id}"
                                   data-field="perItem"
                                   onchange="handleToggleChange(this)">
                            מסמך לכל פריט ברשימה
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox"
                                   ${currentMapping.isSpouse ? 'checked' : ''}
                                   data-mapping="${mapping.id}"
                                   data-field="isSpouse"
                                   onchange="handleToggleChange(this)">
                            שאלה על בן/בת זוג
                        </label>
                    </div>

                    ${docsHtml}
                    ${docPreviewHtml}
                </div>
            `;
        }

        function filterMappings() {
            renderMappings();
        }

        // ==================== DOCUMENT MANAGEMENT ====================

        let activeDropdownMappingId = null;

        function showDocDropdown(mappingId, button) {
            const dropdown = document.getElementById('docDropdown');
            activeDropdownMappingId = mappingId;

            // Get current docs for this mapping
            const mapping = mappings.find(m => m.id === mappingId);
            const currentDocs = changes[mappingId]?.documents || mapping?.documents || [];

            // Build dropdown content
            let html = '';
            for (const [docId, docType] of Object.entries(documentTypes)) {
                if (currentDocs.includes(docId)) continue; // Skip already added
                html += `
                    <div class="doc-dropdown-item" onclick="addDoc('${mappingId}', '${docId}')">
                        <strong>${escapeHtml(docType.name_he)}</strong>
                        <div style="font-size: var(--text-xs); color: var(--gray-500);">${escapeHtml(docType.name_en || '')}</div>
                    </div>
                `;
            }

            if (!html) {
                html = '<div class="doc-dropdown-item" style="color: var(--gray-500);">כל סוגי המסמכים כבר נוספו</div>';
            }

            dropdown.innerHTML = html;

            // Position dropdown
            const rect = button.getBoundingClientRect();
            dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
            dropdown.style.left = `${rect.left + window.scrollX}px`;
            dropdown.style.display = 'block';

            // Close on outside click
            document.addEventListener('click', closeDropdownOnOutsideClick);
        }

        function closeDropdownOnOutsideClick(e) {
            const dropdown = document.getElementById('docDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('.add-doc-btn')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOnOutsideClick);
            }
        }

        function addDoc(mappingId, docId) {
            const mapping = mappings.find(m => m.id === mappingId);
            if (!mapping) return;

            if (!changes[mappingId]) {
                changes[mappingId] = { documents: [...(mapping.documents || [])] };
            }
            if (!changes[mappingId].documents) {
                changes[mappingId].documents = [...(mapping.documents || [])];
            }

            if (!changes[mappingId].documents.includes(docId)) {
                changes[mappingId].documents.push(docId);
            }

            document.getElementById('docDropdown').style.display = 'none';
            renderMappings();
        }

        function removeDoc(mappingId, docId) {
            const mapping = mappings.find(m => m.id === mappingId);
            if (!mapping) return;

            if (!changes[mappingId]) {
                changes[mappingId] = { documents: [...(mapping.documents || [])] };
            }
            if (!changes[mappingId].documents) {
                changes[mappingId].documents = [...(mapping.documents || [])];
            }

            changes[mappingId].documents = changes[mappingId].documents.filter(d => d !== docId);
            renderMappings();
        }

        // ==================== CHANGES ====================

        function handleFieldChange(input) {
            const mappingId = input.dataset.mapping;
            const fieldPath = input.dataset.field;
            const newValue = input.value;

            const mapping = mappings.find(m => m.id === mappingId);
            if (!mapping) return;

            // Get original value using field path
            const getNestedValue = (obj, path) => {
                return path.split('.').reduce((o, k) => o?.[k], obj);
            };
            const originalValue = getNestedValue(mapping, fieldPath) || '';

            if (!changes[mappingId]) {
                changes[mappingId] = {};
            }

            if (newValue !== originalValue) {
                // Set nested value in changes
                if (fieldPath.includes('.')) {
                    const [parent, child] = fieldPath.split('.');
                    if (!changes[mappingId][parent]) {
                        changes[mappingId][parent] = { ...mapping[parent] };
                    }
                    changes[mappingId][parent][child] = newValue;
                } else {
                    changes[mappingId][fieldPath] = newValue;
                }
                input.classList.add('modified');
                input.closest('.mapping-card').classList.add('modified');
            } else {
                // Check if we should remove the change
                if (fieldPath.includes('.')) {
                    const [parent, child] = fieldPath.split('.');
                    if (changes[mappingId][parent]) {
                        delete changes[mappingId][parent][child];
                        if (Object.keys(changes[mappingId][parent]).every(k =>
                            changes[mappingId][parent][k] === mapping[parent]?.[k]
                        )) {
                            delete changes[mappingId][parent];
                        }
                    }
                } else {
                    delete changes[mappingId][fieldPath];
                }

                if (Object.keys(changes[mappingId]).length === 0) {
                    delete changes[mappingId];
                }
                input.classList.remove('modified');

                const card = input.closest('.mapping-card');
                if (!changes[mappingId]) {
                    card.classList.remove('modified');
                }
            }

            updateChangesBar();
        }

        function handleToggleChange(checkbox) {
            const mappingId = checkbox.dataset.mapping;
            const field = checkbox.dataset.field;
            const newValue = checkbox.checked;

            const mapping = mappings.find(m => m.id === mappingId);
            if (!mapping) return;

            const originalValue = mapping[field] || false;

            if (!changes[mappingId]) {
                changes[mappingId] = {};
            }

            if (newValue !== originalValue) {
                changes[mappingId][field] = newValue;
                checkbox.closest('.mapping-card').classList.add('modified');
            } else {
                delete changes[mappingId][field];
                if (Object.keys(changes[mappingId]).length === 0) {
                    delete changes[mappingId];
                    checkbox.closest('.mapping-card').classList.remove('modified');
                }
            }

            updateChangesBar();
        }

        function updateChangesBar() {
            const changesCount = Object.keys(changes).length;
            const bar = document.getElementById('changesBar');
            document.getElementById('changesCount').textContent = changesCount;

            if (changesCount > 0) {
                bar.classList.add('visible');
                document.body.style.paddingBottom = '80px';
            } else {
                bar.classList.remove('visible');
                document.body.style.paddingBottom = '0';
            }
        }

        function discardChanges() {
            if (!confirm('האם אתה בטוח שברצונך לבטל את כל השינויים?')) {
                return;
            }
            changes = {};
            renderMappings();
        }

        function previewChanges() {
            let previewHtml = '<ul style="text-align: right;">';
            for (const [mappingId, changedFields] of Object.entries(changes)) {
                const mapping = mappings.find(m => m.id === mappingId);
                previewHtml += `<li><strong>${mapping?.label?.he || mappingId}</strong>: `;
                previewHtml += Object.keys(changedFields).join(', ');
                previewHtml += '</li>';
            }
            previewHtml += '</ul>';

            showModal('warning', 'תצוגה מקדימה של שינויים', '');
            document.getElementById('modalBody').innerHTML = previewHtml;
        }

        async function saveChanges() {
            const changesCount = Object.keys(changes).length;
            if (changesCount === 0) return;

            if (!confirm(`האם לשמור ${changesCount} שינויים ל-GitHub?`)) {
                return;
            }

            showLoading('שומר שינויים...');

            try {
                // Apply changes to mappings
                const updatedMappings = mappings.map(m => {
                    if (changes[m.id]) {
                        return { ...m, ...changes[m.id] };
                    }
                    return m;
                });

                // Send to n8n webhook
                const response = await fetch(`${API_BASE}/admin-update-questionnaire-mapping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: authToken,
                        categories: categories,
                        mappings: updatedMappings,
                        changes_summary: changes
                    })
                });

                const text = await response.text();
                let data;
                try {
                    data = text ? JSON.parse(text) : {};
                } catch (e) {
                    console.error('Server response:', text);
                    throw new Error('תגובה לא תקינה מהשרת: ' + text.substring(0, 100));
                }

                hideLoading();

                if (!response.ok || !data.ok) {
                    throw new Error(data.error || `HTTP ${response.status}: ${data.message || 'שגיאה בשמירה'}`);
                }

                showModal('success', 'נשמר בהצלחה!', `${changesCount} שינויים נשמרו ל-GitHub.`);

                // Reset state
                mappings = updatedMappings;
                originalMappings = JSON.parse(JSON.stringify(updatedMappings));
                changes = {};
                renderMappings();

            } catch (error) {
                hideLoading();
                console.error('Save error:', error);
                showModal('error', 'שגיאה', 'לא ניתן לשמור: ' + error.message);
            }
        }

        // ==================== UTILITIES ====================

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'מעבד...';
            document.getElementById('loadingOverlay').classList.add('visible');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }

        function showModal(type, title, body) {
            const icons = {
                success: '<i data-lucide="circle-check" class="icon-2xl" style="color: var(--success-500)"></i>',
                error: '<i data-lucide="circle-alert" class="icon-2xl" style="color: var(--danger-500)"></i>',
                warning: '<i data-lucide="alert-triangle" class="icon-2xl" style="color: var(--warning-500)"></i>'
            };
            document.getElementById('modalIcon').innerHTML = icons[type] || icons.success;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('modalStats').innerHTML = '';
            document.getElementById('resultModal').classList.add('visible');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('resultModal').classList.remove('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            // Also escape double quotes for use in HTML attributes
            return div.innerHTML.replace(/"/g, '&quot;');
        }

        // Initialize
        checkAuth();
    </script>
</body>

</html>